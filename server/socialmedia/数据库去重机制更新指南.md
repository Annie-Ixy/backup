# 数据库去重机制更新指南

## 📋 更新概述

将去重机制从 `text + author_name + channel` 扩展为 `text + author_name + channel + last_update`，允许同一用户在不同时间发布相同内容的评论。

## 🚀 部署步骤

### 步骤1：备份数据库（重要！）
```sql
-- 创建表备份
CREATE TABLE ods_dash_social_comments_backup AS 
SELECT * FROM ods_dash_social_comments;
```

### 步骤2：执行数据库迁移
```bash
# 在 MySQL/TiDB 中执行
mysql -u your_username -p mkt < update_duplicate_check_index.sql
```

### 步骤3：重启应用服务
```bash
# 停止服务
./stop.sh  # 或 stop.bat (Windows)

# 启动服务
./start.sh  # 或 start.bat (Windows)
```

### 步骤4：验证更新
```sql
-- 检查新索引是否创建成功
SHOW INDEX FROM ods_dash_social_comments WHERE Key_name = 'uk_duplicate_check_v2';

-- 验证索引字段
SELECT 
    INDEX_NAME,
    COLUMN_NAME,
    SEQ_IN_INDEX
FROM INFORMATION_SCHEMA.STATISTICS 
WHERE TABLE_SCHEMA = 'mkt' 
AND TABLE_NAME = 'ods_dash_social_comments' 
AND INDEX_NAME = 'uk_duplicate_check_v2'
ORDER BY SEQ_IN_INDEX;
```

## 🔍 新去重机制说明

### 唯一性判断条件
现在系统将以下四个字段的组合作为唯一性判断：
1. **text** (前255字符)
2. **author_name** (作者名称)
3. **channel** (平台/渠道)
4. **last_update** (最后更新时间)

### 业务影响
- ✅ **允许**：同一用户在不同时间发布相同内容
- ✅ **允许**：不同用户发布相同内容
- ❌ **阻止**：完全相同的记录（内容+用户+平台+时间都相同）

### 示例场景
```
场景1：允许的情况
- 用户A在2024-01-01 10:00 发布："这个产品很好"
- 用户A在2024-01-02 11:00 发布："这个产品很好" ✅ 允许

场景2：阻止的情况  
- 用户A在2024-01-01 10:00:00 发布："这个产品很好"
- 用户A在2024-01-01 10:00:00 发布："这个产品很好" ❌ 重复阻止
```

## ⚠️ 注意事项

### 时间精度
- 使用完整的 DATETIME 精度（年-月-日 时:分:秒）
- 相同时间戳（精确到秒）的重复内容会被阻止

### 性能影响
- 新增时间字段到索引可能略微影响查询性能
- 但可以提供更精确的去重控制

### 数据迁移
- 现有数据不会受到影响
- 只有新上传的数据会使用新的去重规则

## 🧪 测试验证

### 测试用例1：时间不同的相同内容
```
上传包含以下两条记录的文件：
1. text="测试内容", author_name="test_user", channel="instagram", last_update="2024-01-01 10:00:00"
2. text="测试内容", author_name="test_user", channel="instagram", last_update="2024-01-01 11:00:00"

预期结果：两条记录都成功插入
```

### 测试用例2：完全相同的记录
```
上传包含以下两条记录的文件：
1. text="测试内容", author_name="test_user", channel="instagram", last_update="2024-01-01 10:00:00"
2. text="测试内容", author_name="test_user", channel="instagram", last_update="2024-01-01 10:00:00"

预期结果：第一条成功，第二条被去重阻止
```

## 🔄 回滚方案

如果需要回滚到原来的去重机制：

```sql
-- 删除新索引
DROP INDEX uk_duplicate_check_v2 ON ods_dash_social_comments;

-- 恢复原索引
ALTER TABLE ods_dash_social_comments 
ADD UNIQUE KEY uk_duplicate_check (text(255), author_name, channel);
```

## 📞 技术支持

如有问题，请检查：
1. 数据库连接是否正常
2. 索引是否创建成功
3. 应用日志中的错误信息
4. 新上传数据的去重效果
